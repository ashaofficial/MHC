<!DOCTYPE html>
<html>
<head>
<title>Login</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="../css/login.css">
</head>

<body>
<div class="container">
    <div class="card shadow">
        <div class="card-header text-center">
            <h4>Login</h4>
        </div>

        <div class="card-body">
            <form id="loginForm">

                <div class="mb-3">
                    <label>Username</label>
                    <input name="username" class="form-control" required>
                </div>

                <div class="mb-3">
                    <label>Password</label>
                    <input type="password" name="password" class="form-control" required>
                </div>

                <button class="btn btn-primary w-100" type="submit">
                    Login
                </button>

            </form>

            <div id="msg" class="text-danger text-center mt-3"></div>

        </div>
    </div>
</div>

<script src="../components/notification_js.php"></script>
<?php include '../components/modal-dialogs.php'; ?>
<script>
document.getElementById("loginForm").onsubmit = function(e){
    e.preventDefault();

    let formData = new FormData(this);
    const msgEl = document.getElementById("msg");
    msgEl.innerText = "";

    fetch("login.php", {
        method: "POST",
        body: formData,
        credentials: 'include',
        headers: {
            'Accept': 'application/json'
        }
    })
    .then(async r => {
        const text = await r.text();
        try {
            const data = JSON.parse(text);
            if (data.status === "success") {
                // Server sets HttpOnly cookie; no client-side storage needed
                // Redirect based on role (case-insensitive)
                const role = (data.role || '').toString().toLowerCase();
                if (role === "administrator") window.location = "../dashboard/administrator.php";
                else if (role === "consultant") window.location = "../dashboard/consultant.php";
                else if (role === "receptionist") window.location = "../dashboard/receptionist.php";
                else window.location = "../dashboard/administrator.php";

            } else {
                const errorMsg = data.message || 'Login failed';
                msgEl.innerText = errorMsg;
                if (typeof showErrorModal === 'function') {
                    showErrorModal(errorMsg, 'Login Failed');
                } else if (typeof showError === 'function') {
                    showError(errorMsg);
                }
            }
        } catch (err) {
            // Received non-JSON response (likely a PHP warning/error). Show it to the user for debugging.
            msgEl.innerText = text;
            console.error('Non-JSON response from server:', text);
            if (typeof showErrorModal === 'function') {
                showErrorModal('Login error occurred. Please try again.', 'Error');
            } else if (typeof showError === 'function') {
                showError('Login error occurred. Please try again.');
            }
        }
    })
    .catch(err => {
        msgEl.innerText = 'Network error. Please try again.';
        if (typeof showErrorModal === 'function') {
            showErrorModal('Network error. Please try again.', 'Network Error');
        } else if (typeof showError === 'function') {
            showError('Network error. Please try again.');
        }
    });
};
</script>

</body>
</html>
